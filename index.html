<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Visualize population density</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css" rel="stylesheet" />
<style>
	@font-face {
		font-family: 'Mallory';
		src:  url('https://www.motherjones.com/wp-content/themes/motherjones/font/mallory/mallory-light.woff2') format('woff2'),
		    url('https://www.motherjones.com/wp-content/themes/motherjones/font/mallory/mallory-light.woff') format('woff'),
		    url('https://www.motherjones.com/wp-content/themes/motherjones/font/mallory/mallory-light.otf') format('opentype');
		font-weight: normal;
		font-style: normal;
	}
	@font-face {
		font-family: 'Mallory';
		src:  url('https://www.motherjones.com/wp-content/themes/motherjones/font/mallory/mallory-bold.woff2') format('woff2'),
		    url('https://www.motherjones.com/wp-content/themes/motherjones/font/mallory/mallory-bold.woff') format('woff'),
		    url('https://www.motherjones.com/wp-content/themes/motherjones/font/mallory/mallory-bold.otf') format('opentype');
		font-weight: bold;
		font-style: normal;
	}
	body { margin: 0; padding: 0; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }
	.mapboxgl-popup-content {
		font-family:Mallory, sans-serif;
		border:1px solid #000;
		padding:.5rem 1.5rem;
		box-shadow: 0 0 10px 0 rgba(0,0,0,.333);
	}
	.mapboxgl-popup-anchor-top .mapboxgl-popup-tip,
	.mapboxgl-popup-anchor-bottom .mapboxgl-popup-tip {
		border-top-color:#000;
		border-bottom-color:#000;
	}
	.marker-pin {
		width: 50px;
		height: 50px;
		border-radius: 50% 50% 50% 0;
		background: #ccc;
		position: relative;
		transform: rotate(-45deg);
		/*left: 50%;
		top: 50%;*/
		margin: -35px 0 0 -35px;
		box-shadow: 0 0 0 1.5px #000;
	}
	.marker-pin span {
		display: block;
		transform: rotate(45deg);
		position: absolute;
		font-size: 1.5rem;
		font-weight:bold;
		left: 38%;
		z-index: 1;
		top: 28%;
	}
	.marker-pin::after {
		content: '';
		width: 30px;
		height: 30px;
		margin: 9px 0 0 9px;
		background: #fff;
		position: absolute;
		border-radius: 50%;
		border:1px solid #000;
	}
	.marker-pin.rated-10 {
		background-color:#004529;
	}
	.marker-pin.rated-9 {
		background-color:#006837;
	}
	.marker-pin.rated-8 {
		background-color:#238443;
	}
	.marker-pin.rated-7 {
		background-color:#41ab5d;
	}
	.marker-pin.rated-6 {
		background-color:#78c679;
	}
	.marker-pin.rated-5 {
		background-color:#addd8e;
	}
	.marker-pin.rated-4 {
		background-color:#d9f0a3;
	}
	.marker-pin.rated-3 {
		background-color:#f7fcb9;
	}
	.marker-pin.rated-2 {
		background-color:#ffffe5;
	}
	.marker-pin.rated-1 {
		background-color:#fff;
	}
	.mapboxgl-popup-content h2 {
		margin:.333rem 0 .5rem 0;
	}
	.mapboxgl-popup-content p {
		margin:.5rem 0;
	}

	.filter-group {
		font: 12px/20px 'Mallory', sans-serif;
		font-weight: 600;
		position: absolute;
		top: 10px;
		right: 10px;
		z-index: 1;
		border-radius: 3px;
		width: 120px;
		color: #fff;
	}
		 
	.filter-group input[type='checkbox']:first-child + label {
		border-radius: 3px 3px 0 0;
	}
		 
	.filter-group label:last-child {
		border-radius: 0 0 3px 3px;
		border: none;
	}
		 
	.filter-group input[type='checkbox'] {
		display: none;
	}
		 
	.filter-group input[type='checkbox'] + label {
		background-color: #3386c0;
		display: block;
		cursor: pointer;
		padding: 10px;
		border-bottom: 1px solid rgba(0, 0, 0, 0.25);
	}
		 
	.filter-group input[type='checkbox'] + label {
		background-color: #3386c0;
		text-transform: capitalize;
	}
		 
	.filter-group input[type='checkbox'] + label:hover,
	.filter-group input[type='checkbox']:checked + label {
		background-color: #4ea0da;
	}
		 
	.filter-group input[type='checkbox']:checked + label:before {
		content: 'âœ”';
		margin-right: 5px;
	}
</style>
</head>
<body>
	<div id="map"></div>
	<nav id="filter-group" class="filter-group"></nav>
<script>
	mapboxgl.accessToken = 'pk.eyJ1IjoibW90aGVyam9uZXMiLCJhIjoiY2p2emw3Nzc4MDFpZTQzcGllZzR5c2hmNCJ9.tG_ytBv6NrTA1IR9R_chmA';

var map = new mapboxgl.Map({
	container: 'map', // container id
	//style: 'mapbox://styles/mapbox/light-v10', // stylesheet location
	style: 'mapbox://styles/motherjones/cke841yfj4pay19jv8ija86ms',
	center: [-122.2712, 37.8044], // starting position [lng, lat]
	zoom: 10.75 // starting zoom
});

fetch('data/oakland_white_demographics.geojson')
	.then(res => res.json())
	.then(createMap)
	.catch(e => console.error(e));

function createMap(geojson) {
	//const values = geojson.features.map(d=> +d.properties.B03002003);
	const values = geojson.features.map(function(d){
		const white = d.properties.B03002003;
		const total = d.properties.B03002001;
		var percentage = white/total;//*100;
		return percentage;//.toFixed(2);
	})
	const scale = [
		Math.min.apply(null, values.filter(function(n) { return !isNaN(n); })),
		//'#FF6900',
		'#cc5400',
		Math.max.apply(null, values.filter(function(n) { return !isNaN(n); })),
		//'#FFC107'
		'#ffd34f'
	]

	map.on('load', function() {
		var layers = map.getStyle().layers;
		// Find the index of the first symbol layer in the map style
		var target_layer = layers[4].id;
		// for (var i = 0; i < layers.length; i++) {
		// 	if (layers[i].type === 'symbol') {
		// 		target_layer = layers[i].id;
		// 		break;
		// 	}
		// }
		map.addSource('white-demographics', {
			'type': 'geojson',
			//'data': 'data/acs2018_5yr_B03002_01000US.geojson'
			'data': 'data/oakland_white_demographics.geojson'
		});

		map.addLayer({
			'id': 'white-demographics',
			'type': 'fill',
			'source': 'white-demographics',
			'layout': {},
			'paint': {
			'fill-color':  
				[
					'interpolate',
					['linear'],
					['/', ['get', 'B03002003'], ['get', 'B03002001']],
					//['get', 'B03002003'],
					//['get', 'B03002003']/['get', 'B03002001']*100,
					...scale
				],
			'fill-opacity': 1,
			'fill-outline-color': '#fff'
			}
		}, target_layer);

		map.on('click', 'white-demographics', function(e) {
			var coordinates = e.features[0].geometry.coordinates.slice();
			// var rating = e.features[0].properties.ratings_clean;
			// var school_name = e.features[0].properties.school_name;
			// var scale = e.features[0].properties.gs_scale;
			// var type = e.features[0].properties.school_type;
			// var total = e.features[0].properties.total_students;
			// var ratio = e.features[0].properties.students_per_teacher;

			while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
				coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
			}
			console.log(coordinates[0]);

			var description = 'testing!';
			 
			new mapboxgl.Popup()
			.setLngLat(coordinates[0][0])
			.setHTML(description)
			.addTo(map);
		});
		 
		// Change the cursor to a pointer when the mouse is over the places layer.
		map.on('mouseenter', 'white-demographics', function() {
			map.getCanvas().style.cursor = 'pointer';
		});
		 
		// Change it back to a pointer when it leaves.
		map.on('mouseleave', 'white-demographics', function() {
			map.getCanvas().style.cursor = '';
		});

		// var marker = new mapboxgl.Marker()
		// 	.setLngLat([-122.2712, 37.8044])
		// 	.setPopup(new mapboxgl.Popup().setHTML("<h1>Hello World!</h1>")) // add popup
		// 	.addTo(map);


		map.loadImage(
			'custom_marker_sm.png',
			function(error, image) {
				if (error) throw error;
				map.addImage('custom-marker', image);
				// Add a GeoJSON source with 2 points

				map.addSource('schools', {
					'type': 'geojson',
					//'data': 'data/acs2018_5yr_B03002_01000US.geojson'
					'data': 'data/great_schools_oakland_rated.geojson'
				});

				map.addLayer({
					'id': 'schools',
					'type': 'circle',
					'source': 'schools',
					'paint': {
						// make circles larger as the user zooms from z12 to z22
						'circle-radius': {
							'base': 4.5,
							'stops': [
								[10.75, 4.5],
								[14, 11],
								[18, 60],
								[22, 180]
							]
						},
						// color circles by score, using a match expression
						// https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-match
						'circle-color': [
							'match',
							['get', 'ratings_clean'],
							'10',
							'#004529',
							'9',
							'#006837',
							'8',
							'#238443',
							'7',
							'#41ab5d',
							'6',
							'#78c679',
							'5',
							'#addd8e',
							'4',
							'#d9f0a3',
							'3',
							'#f7fcb9',
							'2',
							'#ffffe5',
							'1',
							'#fff',
							/* other */ '#ddd'
						],
						//'circle-opacity': 0,
					    'circle-stroke-width': 1,
					    'circle-stroke-color': '#000'
					}
				});

				// map.addLayer({
				// 	'id': 'school_marker',
				// 	'type': 'symbol',
				// 	'source': 'schools',
				// 	'layout': {
				// 		'icon-image': 'custom-marker',
				// 		'icon-allow-overlap': true,
				// 		// get the title name from the source's "title" property
				// 		'text-field': ['get', 'ratings_clean'],
				// 		'text-font': [
				// 			'Open Sans Semibold',
				// 			'Arial Unicode MS Bold'
				// 		],
				// 		'text-offset': [0, 1.25],
				// 		'text-anchor': 'top',
				// 		'text-allow-overlap': true
				// 	}
				// });

				// When a click event occurs on a feature in the places layer, open a popup at the
				// location of the feature, with description HTML from its properties.
				map.on('click', 'schools', function(e) {
					var coordinates = e.features[0].geometry.coordinates.slice();
					var rating = e.features[0].properties.ratings_clean;
					var school_name = e.features[0].properties.school_name;
					var scale = e.features[0].properties.gs_scale;
					var type = e.features[0].properties.school_type;
					var total = e.features[0].properties.total_students;
					var ratio = e.features[0].properties.students_per_teacher;

					var description = '<div class="marker-pin rated-' + rating + '"><span>' + rating + '</span></div>';
					description += '<h2>' + school_name + '</h2>';
					description += '<p><strong>' + rating + '/10</strong> GreatSchools Rating</p>';
					// description += '<p>Type: ' + type + '</p>';
					// description += '<p>Total Students: ' + total + '</p>';
					// description += '<p>Students per Teacher: ' + ratio + '</p>';
					 
					// Ensure that if the map is zoomed out such that multiple
					// copies of the feature are visible, the popup appears
					// over the copy being pointed to.
					while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
						coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
					}
					 
					new mapboxgl.Popup()
					.setLngLat(coordinates)
					.setHTML(description)
					.addTo(map);
				});
				 
				// Change the cursor to a pointer when the mouse is over the places layer.
				map.on('mouseenter', 'schools', function() {
					map.getCanvas().style.cursor = 'pointer';
				});
				 
				// Change it back to a pointer when it leaves.
				map.on('mouseleave', 'schools', function() {
					map.getCanvas().style.cursor = '';
				});
			}
		);

		

	});
}




</script>
 
</body>
</html>